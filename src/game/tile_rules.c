#include "tile_rules.h"
#include <stdint.h>
#include "stdio.h"

TileRule tileRules[256] = {
    {0b00000000, 24},
    {0b00000001, 24},
    {0b00000010, 15},
    {0b00000011, 15},
    {0b00000100, 24},
    {0b00000101, 24},
    {0b00000110, 15},
    {0b00000111, 15},
    {0b00001000, 14},
    {0b00001001, 14},
    {0b00001010, 45},
    {0b00001011, 41},
    {0b00001100, 14},
    {0b00001101, 14},
    {0b00001110, 45},
    {0b00001111, 41},
    {0b00010000, 12},
    {0b00010001, 12},
    {0b00010010, 42},
    {0b00010011, 42},
    {0b00010100, 12},
    {0b00010101, 12},
    {0b00010110, 32},
    {0b00010111, 32},
    {0b00011000, 10},
    {0b00011001, 10},
    {0b00011010, 35},
    {0b00011011, 34},
    {0b00011100, 10},
    {0b00011101, 10},
    {0b00011110, 36},
    {0b00011111, 2},
    {0b00100000, 24},
    {0b00100001, 24},
    {0b00100010, 15},
    {0b00100011, 15},
    {0b00100100, 24},
    {0b00100101, 24},
    {0b00100110, 15},
    {0b00100111, 15},
    {0b00101000, 14},
    {0b00101001, 14},
    {0b00101010, 45},
    {0b00101011, 41},
    {0b00101100, 14},
    {0b00101101, 14},
    {0b00101110, 45},
    {0b00101111, 41},
    {0b00110000, 12},
    {0b00110001, 12},
    {0b00110010, 42},
    {0b00110011, 42},
    {0b00110100, 12},
    {0b00110101, 12},
    {0b00110110, 32},
    {0b00110111, 32},
    {0b00111000, 10},
    {0b00111001, 10},
    {0b00111010, 35},
    {0b00111011, 34},
    {0b00111100, 10},
    {0b00111101, 10},
    {0b00111110, 36},
    {0b00111111, 2},
    {0b01000000, 13},
    {0b01000001, 13},
    {0b01000010, 11},
    {0b01000011, 11},
    {0b01000100, 13},
    {0b01000101, 13},
    {0b01000110, 11},
    {0b01000111, 11},
    {0b01001000, 44},
    {0b01001001, 44},
    {0b01001010, 30},
    {0b01001011, 29},
    {0b01001100, 44},
    {0b01001101, 44},
    {0b01001110, 30},
    {0b01001111, 29},
    {0b01010000, 43},
    {0b01010001, 43},
    {0b01010010, 22},
    {0b01010011, 22},
    {0b01010100, 43},
    {0b01010101, 43},
    {0b01010110, 23},
    {0b01010111, 23},
    {0b01011000, 38},
    {0b01011001, 38},
    {0b01011010, 20},
    {0b01011011, 25},
    {0b01011100, 38},
    {0b01011101, 38},
    {0b01011110, 28},
    {0b01011111, 16},
    {0b01100000, 13},
    {0b01100001, 13},
    {0b01100010, 11},
    {0b01100011, 11},
    {0b01100100, 13},
    {0b01100101, 13},
    {0b01100110, 11},
    {0b01100111, 11},
    {0b01101000, 40},
    {0b01101001, 40},
    {0b01101010, 31},
    {0b01101011, 5},
    {0b01101100, 40},
    {0b01101101, 40},
    {0b01101110, 31},
    {0b01101111, 5},
    {0b01110000, 43},
    {0b01110001, 43},
    {0b01110010, 22},
    {0b01110011, 22},
    {0b01110100, 43},
    {0b01110101, 43},
    {0b01110110, 23},
    {0b01110111, 23},
    {0b01111000, 39},
    {0b01111001, 39},
    {0b01111010, 27},
    {0b01111011, 18},
    {0b01111100, 39},
    {0b01111101, 39},
    {0b01111110, 17},
    {0b01111111, 0},
    {0b10000000, 24},
    {0b10000001, 24},
    {0b10000010, 15},
    {0b10000011, 15},
    {0b10000100, 24},
    {0b10000101, 24},
    {0b10000110, 15},
    {0b10000111, 15},
    {0b10001000, 14},
    {0b10001001, 14},
    {0b10001010, 45},
    {0b10001011, 41},
    {0b10001100, 14},
    {0b10001101, 14},
    {0b10001110, 45},
    {0b10001111, 41},
    {0b10010000, 12},
    {0b10010001, 12},
    {0b10010010, 42},
    {0b10010011, 42},
    {0b10010100, 12},
    {0b10010101, 12},
    {0b10010110, 32},
    {0b10010111, 32},
    {0b10011000, 10},
    {0b10011001, 10},
    {0b10011010, 35},
    {0b10011011, 34},
    {0b10011100, 10},
    {0b10011101, 10},
    {0b10011110, 36},
    {0b10011111, 2},
    {0b10100000, 24},
    {0b10100001, 24},
    {0b10100010, 15},
    {0b10100011, 15},
    {0b10100100, 24},
    {0b10100101, 24},
    {0b10100110, 15},
    {0b10100111, 15},
    {0b10101000, 14},
    {0b10101001, 14},
    {0b10101010, 45},
    {0b10101011, 41},
    {0b10101100, 14},
    {0b10101101, 14},
    {0b10101110, 45},
    {0b10101111, 41},
    {0b10110000, 12},
    {0b10110001, 12},
    {0b10110010, 42},
    {0b10110011, 42},
    {0b10110100, 12},
    {0b10110101, 12},
    {0b10110110, 32},
    {0b10110111, 32},
    {0b10111000, 10},
    {0b10111001, 10},
    {0b10111010, 35},
    {0b10111011, 34},
    {0b10111100, 10},
    {0b10111101, 10},
    {0b10111110, 36},
    {0b10111111, 2},
    {0b11000000, 13},
    {0b11000001, 13},
    {0b11000010, 11},
    {0b11000011, 11},
    {0b11000100, 13},
    {0b11000101, 13},
    {0b11000110, 11},
    {0b11000111, 11},
    {0b11001000, 44},
    {0b11001001, 44},
    {0b11001010, 30},
    {0b11001011, 29},
    {0b11001100, 44},
    {0b11001101, 44},
    {0b11001110, 30},
    {0b11001111, 29},
    {0b11010000, 33},
    {0b11010001, 33},
    {0b11010010, 21},
    {0b11010011, 21},
    {0b11010100, 33},
    {0b11010101, 33},
    {0b11010110, 4},
    {0b11010111, 4},
    {0b11011000, 37},
    {0b11011001, 37},
    {0b11011010, 26},
    {0b11011011, 6},
    {0b11011100, 37},
    {0b11011101, 37},
    {0b11011110, 7},
    {0b11011111, 1},
    {0b11100000, 13},
    {0b11100001, 13},
    {0b11100010, 11},
    {0b11100011, 11},
    {0b11100100, 13},
    {0b11100101, 13},
    {0b11100110, 11},
    {0b11100111, 11},
    {0b11101000, 40},
    {0b11101001, 40},
    {0b11101010, 31},
    {0b11101011, 5},
    {0b11101100, 40},
    {0b11101101, 40},
    {0b11101110, 31},
    {0b11101111, 5},
    {0b11110000, 33},
    {0b11110001, 33},
    {0b11110010, 21},
    {0b11110011, 21},
    {0b11110100, 33},
    {0b11110101, 33},
    {0b11110110, 4},
    {0b11110111, 4},
    {0b11111000, 3},
    {0b11111001, 3},
    {0b11111010, 19},
    {0b11111011, 8},
    {0b11111100, 3},
    {0b11111101, 3},
    {0b11111110, 9},
    {0b11111111, 46},
};

void initTileRulesHashMap(TileRule **tileRulesHashMap)
{
  *tileRulesHashMap = NULL;

  for (int i = 0; i < 256; ++i)
  {
    TileRule *newRule = malloc(sizeof(TileRule));
    newRule->mask = tileRules[i].mask;
    newRule->index = tileRules[i].index;

    HASH_ADD(hh, *tileRulesHashMap, mask, sizeof(uint8_t), newRule);
  }
}

uint8_t getTileIndex(TileRule *tileRulesHashMap, uint8_t mask)
{
  TileRule *tileRule = NULL;
  HASH_FIND(hh, tileRulesHashMap, &mask, sizeof(uint8_t), tileRule);

  if (tileRule)
  {
    return tileRule->index;
  }

  return 0;
}

Rectangle getTileSourceRect(TileRule *tileRulesHashMap, Level *level, int x, int y)
{
  uint8_t mask = getTileBitmask(level, x, y);
  int index = getTileIndex(tileRulesHashMap, mask);

  return (Rectangle){
      .x = (index % TILES_PER_ROW) * TILE_SIZE,
      .y = (index / TILES_PER_ROW) * TILE_SIZE,
      .width = TILE_SIZE,
      .height = TILE_SIZE};
}

uint8_t getTileBitmask(Level *level, int x, int y)
{
  uint8_t mask = 0;

  const int dx[8] = {-1, 0, 1, -1, 1, -1, 0, 1};
  const int dy[8] = {-1, -1, -1, 0, 0, 1, 1, 1};
  const uint8_t bits[8] = {1, 2, 4, 8, 16, 32, 64, 128};

  for (int i = 0; i < 8; ++i)
  {
    int nx = x + dx[i];
    int ny = y + dy[i];

    TILE_TYPE neighbor =
        (nx >= 0 && nx < MAP_SIZE && ny >= 0 && ny < MAP_SIZE)
            ? level->tiles[nx][ny]
            : TILE_GROUND;

    if (neighbor == TILE_GROUND)
    {
      mask |= bits[i];
    }
  }

  return mask;
}
